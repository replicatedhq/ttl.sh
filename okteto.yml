build:
  ttl-registry:
    context: ./registry
    dockerfile: ./registry/Dockerfile
  ttl-blob-reap:
    context: ./registry
    dockerfile: ./registry/Dockerfile.blob-reap
  ttl-hooks:
    context: ./hooks
    dockerfile: ./hooks/Dockerfile.hooks
  ttl-reaper:
    context: ./hooks
    dockerfile: ./hooks/Dockerfile.reap

deploy:
  - cd kustomize/overlays/dev && kustomize edit set image ttl-registry=${OKTETO_BUILD_TTL_REGISTRY_IMAGE}
  - cd kustomize/overlays/dev && kustomize edit set image ttl-blob-reap=${OKTETO_BUILD_TTL_BLOB_REAP_IMAGE}
  - cd kustomize/overlays/dev && kustomize edit set image ttl-hooks=${OKTETO_BUILD_TTL_HOOKS_IMAGE}
  - cd kustomize/overlays/dev && kustomize edit set image ttl-reaper=${OKTETO_BUILD_TTL_REAPER_IMAGE}

  - kubectl apply -k kustomize/overlays/dev

dev:
  ttl-hooks:
    command: make deps build && bash || bash
    workdir: /src
    sync:
      - ./hooks:/src
    resources:
      limits:
        cpu: "1"
        memory: 1Gi
  ttl-reaper:
    command: make deps build && bash || bash
    workdir: /src
    sync:
      - ./hooks:/src
    resources:
      limits:
        cpu: "1"
        memory: 1Gi
